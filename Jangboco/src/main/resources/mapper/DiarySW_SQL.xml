<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DiarySW">

	<select id="getAllDiaryCnt" resultType="Integer">
		SELECT count(*)
		FROM(
			SELECT D5.DIARY_NO, D5.MEMBER_NO, D5.CON, D5.HIT_NUM, D5.CNT, D5.IMG_URL, M.NICNM, ROW_NUMBER() OVER(ORDER BY D5.DIARY_NO DESC) AS RNUM
				FROM (SELECT D3.DIARY_NO, D3.MEMBER_NO, D3.CON, D3.HIT_NUM, D3.CNT, D4.IMG_URL FROM 
					(SELECT D.DIARY_NO, D.MEMBER_NO, D.CON, D.HIT_NUM, D2.CNT
						FROM DIARY D , (SELECT DIARY_NO, COUNT(*) AS CNT
							FROM DIARY_LIKE
							GROUP BY DIARY_NO) D2
							WHERE D.DIARY_NO = D2.DIARY_NO(+)) D3, 
							
							(SELECT D2.IMG_NO, D1.DIARY_NO, D2.IMG_URL, D2.RNUM FROM DIARY D1, 
							(SELECT IMG_NO, DIARY_NO,IMG_URL, ROW_NUMBER() OVER (PARTITION BY DIARY_NO ORDER BY IMG_NO ASC) AS RNUM
							FROM DIARY_IMG) D2 
						WHERE D1.DIARY_NO = D2.DIARY_NO AND RNUM = 1) D4
					
					WHERE D3.DIARY_NO = D4.DIARY_NO(+)
				) D5, MEMBER M
			WHERE D5.MEMBER_NO = M.MEMBER_NO
		) 
	</select>
	
	<select id="getAllDiaryList" parameterType="hashmap" resultType="hashmap">
		
		SELECT DIARY_NO, MEMBER_NO, CON, HIT_NUM, CNT AS LIKE_CNT, IMG_URL, NICNM, MEMBER_IMG, RNUM
			FROM(
				SELECT D5.DIARY_NO, D5.MEMBER_NO, D5.CON, D5.HIT_NUM, D5.CNT, D5.IMG_URL, M.NICNM, M.IMG_URL AS MEMBER_IMG, ROW_NUMBER() OVER(ORDER BY D5.DIARY_NO DESC) AS RNUM
				FROM (SELECT D3.DIARY_NO, D3.MEMBER_NO, D3.CON, D3.HIT_NUM, D3.CNT, D4.IMG_URL FROM 
				(SELECT D.DIARY_NO, D.MEMBER_NO, D.CON, D.HIT_NUM, D2.CNT
				FROM DIARY D , (SELECT DIARY_NO, COUNT(*) AS CNT
				FROM DIARY_LIKE
				GROUP BY DIARY_NO) D2
				WHERE D.DIARY_NO = D2.DIARY_NO(+)) D3, 
				
				(SELECT D2.IMG_NO, D1.DIARY_NO, D2.IMG_URL, D2.RNUM FROM DIARY D1, 
				(SELECT IMG_NO, DIARY_NO,IMG_URL, ROW_NUMBER() OVER (PARTITION BY DIARY_NO ORDER BY IMG_NO ASC) AS RNUM
				FROM DIARY_IMG) D2 
				WHERE D1.DIARY_NO = D2.DIARY_NO AND RNUM = 1) D4
				
				WHERE D3.DIARY_NO = D4.DIARY_NO(+)
				) D5, MEMBER M
				WHERE D5.MEMBER_NO = M.MEMBER_NO
			) D6
		WHERE D6.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<select id="getSearchDiaryCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*)
			FROM (SELECT D6.DIARY_NO, D6.MEMBER_NO, D6.CON, D6.HIT_NUM, D6.CNT, D6.IMG_URL, D6.NICNM, H1.HASTG_NAME, ROW_NUMBER() OVER(ORDER BY D6.DIARY_NO DESC) AS RNUM
			FROM (SELECT D5.DIARY_NO, D5.MEMBER_NO, D5.CON, D5.HIT_NUM, D5.CNT, D5.IMG_URL, M.NICNM
			FROM (SELECT D3.DIARY_NO, D3.MEMBER_NO, D3.CON, D3.HIT_NUM, D3.CNT, D4.IMG_URL FROM 
			(SELECT D.DIARY_NO, D.MEMBER_NO, D.CON, D.HIT_NUM, D2.CNT
			FROM DIARY D , (SELECT DIARY_NO, COUNT(*) AS CNT
			FROM DIARY_LIKE
			GROUP BY DIARY_NO) D2
			WHERE D.DIARY_NO = D2.DIARY_NO(+)) D3, 
			
			(SELECT D2.IMG_NO, D1.DIARY_NO, D2.IMG_URL, D2.RNUM FROM DIARY D1, 
			(SELECT IMG_NO, DIARY_NO,IMG_URL, ROW_NUMBER() OVER (PARTITION BY DIARY_NO ORDER BY IMG_NO ASC) AS RNUM
			FROM DIARY_IMG) D2 
			WHERE D1.DIARY_NO = D2.DIARY_NO AND RNUM = 1) D4
			
			WHERE D3.DIARY_NO = D4.DIARY_NO(+)
			) D5, MEMBER M
			WHERE D5.MEMBER_NO = M.MEMBER_NO
			) D6, (SELECT DIARY_NO, DH.HASTG_NO, H.HASTG_NAME FROM DIARY_HASTG DH, HASTG H
			WHERE DH.HASTG_NO = H.HASTG_NO) H1
			WHERE D6.DIARY_NO = H1.DIARY_NO(+) AND H1.HASTG_NAME LIKE '%' ||#{searchTxt}||'%'
		) D7
	</select>
	
	<select id="getSearchDiaryList" parameterType="hashmap" resultType="hashmap">
		SELECT DIARY_NO, MEMBER_NO, CON, HIT_NUM, CNT AS LIKE_CNT, IMG_URL, NICNM, MEMBER_IMG, HASTG_NAME, RNUM
			FROM (SELECT D6.DIARY_NO, D6.MEMBER_NO, D6.CON, D6.HIT_NUM, D6.CNT, D6.IMG_URL, D6.NICNM, D6.MEMBER_IMG H1.HASTG_NAME, ROW_NUMBER() OVER(ORDER BY D6.DIARY_NO DESC) AS RNUM
			FROM (SELECT D5.DIARY_NO, D5.MEMBER_NO, D5.CON, D5.HIT_NUM, D5.CNT, D5.IMG_URL, M.NICNM, M.IMG_URL AS MEMBER_IMG
			FROM (SELECT D3.DIARY_NO, D3.MEMBER_NO, D3.CON, D3.HIT_NUM, D3.CNT, D4.IMG_URL FROM 
			(SELECT D.DIARY_NO, D.MEMBER_NO, D.CON, D.HIT_NUM, D2.CNT
			FROM DIARY D , (SELECT DIARY_NO, COUNT(*) AS CNT
			FROM DIARY_LIKE
			GROUP BY DIARY_NO) D2
			WHERE D.DIARY_NO = D2.DIARY_NO(+)) D3, 
			
			(SELECT D2.IMG_NO, D1.DIARY_NO, D2.IMG_URL, D2.RNUM FROM DIARY D1, 
			(SELECT IMG_NO, DIARY_NO,IMG_URL, ROW_NUMBER() OVER (PARTITION BY DIARY_NO ORDER BY IMG_NO ASC) AS RNUM
			FROM DIARY_IMG) D2 
			WHERE D1.DIARY_NO = D2.DIARY_NO AND RNUM = 1) D4
			
			WHERE D3.DIARY_NO = D4.DIARY_NO(+)
			) D5, MEMBER M
			WHERE D5.MEMBER_NO = M.MEMBER_NO
			) D6, (SELECT DIARY_NO, DH.HASTG_NO, H.HASTG_NAME FROM DIARY_HASTG DH, HASTG H
			WHERE DH.HASTG_NO = H.HASTG_NO) H1
			WHERE D6.DIARY_NO = H1.DIARY_NO(+) AND H1.HASTG_NAME LIKE '%' ||#{searchTxt}||'%'
			) D7
		WHERE D7.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<select id="getLikeDiaryList" parameterType="hashmap" resultType="hashmap">
   		SELECT DIARY_NO, MEMBER_NO, CON, HIT_NUM, CNT AS LIKE_CNT, IMG_URL, NICNM, MEMBER_IMG, RNUM
		FROM(
			SELECT D5.DIARY_NO, D5.MEMBER_NO, D5.CON, D5.HIT_NUM, D5.CNT, D5.IMG_URL, M.NICNM, M.IMG_URL AS MEMBER_IMG, ROW_NUMBER() OVER(ORDER BY D5.DIARY_NO DESC) AS RNUM
			FROM (SELECT D3.DIARY_NO, D3.MEMBER_NO, D3.CON, D3.HIT_NUM, D3.CNT, D4.IMG_URL FROM 
			(SELECT D.DIARY_NO, D.MEMBER_NO, D.CON, D.HIT_NUM, D2.CNT
			FROM DIARY D , (       SELECT DIARY_NO, COUNT(*) AS CNT
			FROM DIARY_LIKE WHERE DIARY_NO IN (SELECT DIARY_NO FROM DIARY_LIKE WHERE MEMBER_NO = #{member_no})
			GROUP BY DIARY_NO
               ) D2
			WHERE D.DIARY_NO = D2.DIARY_NO) D3, 
			
			(SELECT D2.IMG_NO, D1.DIARY_NO, D2.IMG_URL, D2.RNUM FROM DIARY D1, 
			(SELECT IMG_NO, DIARY_NO,IMG_URL, ROW_NUMBER() OVER (PARTITION BY DIARY_NO ORDER BY IMG_NO ASC) AS RNUM
			FROM DIARY_IMG) D2 
			WHERE D1.DIARY_NO = D2.DIARY_NO AND RNUM = 1) D4
			
			WHERE D3.DIARY_NO = D4.DIARY_NO(+)
			) D5, MEMBER M
			WHERE D5.MEMBER_NO = M.MEMBER_NO
		) D6
		WHERE D6.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<select id="getLikeDiaryCnt" parameterType="Integer" resultType="Integer">
          SELECT COUNT(*)
	         FROM(
	            SELECT D5.DIARY_NO, D5.MEMBER_NO, D5.CON, D5.HIT_NUM, D5.CNT, D5.IMG_URL, M.NICNM, ROW_NUMBER() OVER(ORDER BY D5.DIARY_NO DESC) AS RNUM
	            FROM (SELECT D3.DIARY_NO, D3.MEMBER_NO, D3.CON, D3.HIT_NUM, D3.CNT, D4.IMG_URL FROM 
	            (SELECT D.DIARY_NO, D.MEMBER_NO, D.CON, D.HIT_NUM, D2.CNT
	            FROM DIARY D , (       SELECT DIARY_NO, COUNT(*) AS CNT
	            FROM DIARY_LIKE WHERE DIARY_NO IN (SELECT DIARY_NO FROM DIARY_LIKE WHERE MEMBER_NO = #{member_no})
	            GROUP BY DIARY_NO
	                ) D2
	            WHERE D.DIARY_NO = D2.DIARY_NO) D3, 
	            
	            (SELECT D2.IMG_NO, D1.DIARY_NO, D2.IMG_URL, D2.RNUM FROM DIARY D1, 
	            (SELECT IMG_NO, DIARY_NO,IMG_URL, ROW_NUMBER() OVER (PARTITION BY DIARY_NO ORDER BY IMG_NO ASC) AS RNUM
	            FROM DIARY_IMG) D2 
	            WHERE D1.DIARY_NO = D2.DIARY_NO AND RNUM = 1) D4
	            
	            WHERE D3.DIARY_NO = D4.DIARY_NO(+)
	            ) D5, MEMBER M
	            WHERE D5.MEMBER_NO = M.MEMBER_NO
	         ) D6
	</select>
	
	<select id="getMemberNo" parameterType="String" resultType="Integer">
        SELECT MEMBER_NO FROM MEMBER WHERE EMAIL = #{0}
	</select>
	
	<select id="getDiaryPernlCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*)
		FROM  
		(SELECT D3.MEMBER_NO, D3.DIARY_NO, IMG_NO, IMG_URL FROM DIARY D, 
		(SELECT  D1.MEMBER_NO, D1.DIARY_NO, D2.IMG_NO, D2.IMG_URL, ROW_NUMBER() OVER (PARTITION BY D1.DIARY_NO ORDER BY IMG_NO ASC) AS RNUM FROM DIARY D1, DIARY_IMG D2 
		WHERE D1.DIARY_NO = D2.DIARY_NO(+) AND D1.MEMBER_NO = #{page_member_no}) D3 
		WHERE D3.DIARY_NO = D.DIARY_NO(+) AND D3.RNUM = 1
		) D4
	</select>
	
	<select id="getDiaryPernlList" parameterType="hashmap" resultType="hashmap">
		SELECT MEMBER_NO, DIARY_NO, IMG_NO, IMG_URL FROM (
		SELECT MEMBER_NO, DIARY_NO, IMG_NO, IMG_URL, ROW_NUMBER() OVER (PARTITION BY MEMBER_NO ORDER BY DIARY_NO DESC) RNUM2 
		FROM  
		(SELECT D3.MEMBER_NO, D3.DIARY_NO, IMG_NO, IMG_URL FROM DIARY D, 
		(SELECT  D1.MEMBER_NO, D1.DIARY_NO, D2.IMG_NO, D2.IMG_URL, ROW_NUMBER() OVER (PARTITION BY D1.DIARY_NO ORDER BY IMG_NO ASC) AS RNUM FROM DIARY D1, DIARY_IMG D2 
		WHERE D1.DIARY_NO = D2.DIARY_NO(+) AND D1.MEMBER_NO = #{page_member_no}) D3 
		WHERE D3.DIARY_NO = D.DIARY_NO(+) AND D3.RNUM = 1
		) D4
		) D5
		WHERE D5.RNUM2 BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<select id="getMemberImg" parameterType="hashmap" resultType="String">
		SELECT IMG_URL FROM MEMBER WHERE MEMBER_NO = #{member_no}
	</select>
	
	<select id="getFolwrFolwng" parameterType="hashmap" resultType="hashmap">
		SELECT *
		FROM (SELECT COUNT(*) AS FOLWR FROM FOLW WHERE TARGET_MEMBER_NO = #{member_no}) A LEFT OUTER JOIN
       (SELECT COUNT(*) AS FOLWNG FROM FOLW WHERE REQ_MEMBER_NO = #{member_no}) B  ON  1 = 1
	</select>
	
	<select id="getFolwrList" parameterType="hashmap" resultType="hashmap">
		SELECT MEMBER_NO, NICNM
		FROM MEMBER M, (SELECT REQ_MEMBER_NO FROM FOLW WHERE TARGET_MEMBER_NO = #{member_no}) F
		WHERE MEMBER_NO = REQ_MEMBER_NO
	</select>
	
	<select id="getFolwngList" parameterType="hashmap" resultType="hashmap">
		SELECT MEMBER_NO, NICNM
		FROM MEMBER M, (SELECT TARGET_MEMBER_NO FROM FOLW WHERE REQ_MEMBER_NO = #{member_no}) F
		WHERE MEMBER_NO = TARGET_MEMBER_NO
	</select>
	
	<select id="checkFolw" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS FOLWR FROM FOLW WHERE TARGET_MEMBER_NO = #{page_member_no} AND REQ_MEMBER_NO = #{my_member_no}
	</select>
	
	<insert id="folw" parameterType="hashmap">
       INSERT INTO FOLW (FOLW_NO, REQ_MEMBER_NO, TARGET_MEMBER_NO, REGST_DATE)
       VALUES (FOLW_SEQ.NEXTVAL, #{my_member_no}, #{page_member_no}, SYSDATE)
	</insert>
	
	<delete id="unfolw" parameterType="hashmap">
      DELETE FROM FOLW 
      WHERE REQ_MEMBER_NO = #{my_member_no} AND TARGET_MEMBER_NO = #{page_member_no}
	</delete>
	
</mapper>